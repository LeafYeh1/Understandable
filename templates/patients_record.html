<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>患者聊天紀錄</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #e8f1fc;
      margin: 20px;
    }
    #container {
      display: flex;
      margin-top: 20px;
    }
    #dates {
      width: 30%;
      border-right: 1px solid #ccc;
      padding-right: 10px;
    }
    #logs {
      width: 70%;
      padding-left: 10px;
    }
    .date-item {
      padding: 8px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
    }
    .date-item:hover {
      background-color: #f0f0f0;
    }
    .log-entry {
      margin-bottom: 10px;
      padding: 6px;
      border-radius: 5px;
    }
    .patient {
      background-color: #e0f7fa;
      text-align: left;
    }
    .counselor {
      background-color: #ffe0b2;
      text-align: right;
    }
    .time {
      font-size: 12px;
      color: #666;
    }
  </style>
</head>
<body>
  <h2>患者聊天紀錄</h2>

  <!-- 上方患者選單 -->
  <label for="patientSelect">選擇患者：</label>
  <select id="patientSelect">
    {% for pid, name in patients %}
      <option value="{{ uid }}">{{ name }}</option>
    {% endfor %}
  </select>

  <div id="container">
    <!-- 左側日期 -->
    <div id="dates"></div>
    <!-- 右側聊天紀錄 -->
    <div id="logs"><p>請先選擇日期</p></div>
  </div>

  <script>
    const patientSelect = document.getElementById("patientSelect");
    const datesDiv = document.getElementById("dates");
    const logsDiv = document.getElementById("logs");

    // 載入患者日期
    function loadDates(userId) {
        fetch(`/get_dates/${userId}`)
            .then(res => res.json())
            .then(dates => {
            datesDiv.innerHTML = "";
            logsDiv.innerHTML = "<p>請先選擇日期</p>";
            dates.forEach(date => {
                const div = document.createElement("div");
                div.className = "date-item";
                div.textContent = date;
                div.onclick = () => loadLogs(userId, date);
                datesDiv.appendChild(div);
            });
            });
        }

    // 載入聊天紀錄
    function loadLogs(userId, date) {
    fetch(`/get_logs/${userId}/${date}`)
        .then(res => res.json())
        .then(logs => {
        logsDiv.innerHTML = "";
        logs.forEach(([role, text, time]) => {
            const div = document.createElement("div");
            div.className = "log-entry " + (role === "patient" ? "patient" : "counselor");
            div.innerHTML = `<strong>${role}：</strong> ${text}<br><span class="time">${time}</span>`;
            logsDiv.appendChild(div);
        });
        });
    }

    // 初始化：載入第一位患者的日期
    patientSelect.addEventListener("change", () => {
      loadDates(patientSelect.value);
    });
    window.onload = () => {
      if (patientSelect.value) {
        loadDates(patientSelect.value);
      }
    };
  </script>
</body>
</html>
