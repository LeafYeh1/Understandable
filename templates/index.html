<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>情有可原</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            background-color: #e8f1fc;
            margin: 0;
            padding: 40px;
        }
        h2 {
            color: #2a5dba;
        }
        #result {
            margin-top: 20px;
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }
        #audioFile {
            margin-bottom: 10px;
        }
        canvas {
            max-width: 100%;
            height: auto;
        }
        .box-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
            flex-wrap: wrap;
        }
        .box {
            width: 400px;
            height: 400px;
            border: 2px solid #a3c0e9;
            border-radius: 15px;
            padding: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            text-align: center;     
            background-color: #ffffff;
            overflow-y: hidden;
        }
        .bottom-box {
            width: 640px;
            height: 300px;
            border: 2px solid #a3c0e9;
            border-radius: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            padding: 10px;
            background-color: #ffffff;
            margin: 30px auto;
            overflow-y: hidden;
        }
        #finalButton {
            padding: 10px 20px;
            font-size: 16px;
            border-radius: 8px;
            background-color: #2a5dba;
            color: white;
            border: none;
            cursor: pointer;
        }
        canvas {
            max-width: 100%;
            max-height: 300px;
            height: auto;
        }

        #finalButton:hover, button:hover {
            background-color: #1d4893;
        }
        #emotionLegend {
            margin-top: 20px;
            font-size: 15px;
            background-color: #ffffff;
            border: 2px solid #a3c0e9;
            border-radius: 10px;
            padding: 12px;
            line-height: 1.8;
            width: fit-content;
            margin-left: auto;
            margin-right: auto;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        }
        #suggestionText {
            font-size: 16px;
            line-height: 1.8;
            text-align: left;
            white-space: pre-wrap; /* 防止意外空白折行 */
            max-height: 220px;     /* 建議高度，可依需求調整 */
            overflow-y: auto;      /* 超出時可滾動 */
            padding-right: 8px;    /* 避免滾動條壓住文字 */
        }

    </style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <h2>上傳音訊檔案進行情緒辨識</h2>
    {% if session.role == "counselor" %}
        <label for="patientSelect">選擇患者：</label>
        <select id="patientSelect">
            {% for patient in patients %}
                <option value="{{ patient.name }}">{{ patient.name }}</option>
            {% endfor %}
        </select><br/><br/>
    {% endif %}
    <input type="file" id="audioFile" accept=".wav" />
    <br/>
    <button onclick="uploadFile()">上傳並辨識</button>
    <p id="result">預測結果將顯示在這裡</p>
    <div id="emotionLegend" class="legend-box">
        <strong>情緒對應說明：</strong><br/>
        ang: 生氣😠 、dis: 厭惡🤢 、fear: 害怕😨 、
        happy: 開心😊 、neu: 中性😐 、sad: 傷心😢 
    </div>
    <!-- 兩個可放東西的框 -->
    <div class="box-container">
        <div class="box" id="box1">
            <h3>整體情緒圓餅圖</h3>
            <canvas id="pieChart" width="280" height="180"></canvas>
        </div>
        <div class="box" id="box2">
            <h3>時間序列折線圖</h3>
            <canvas id="lineChart" width="280" height="180"></canvas>
        </div>
    </div>

    <!-- 第三個框，放在下面 -->
    <div class="bottom-box" id="box3">
        <h3>文字建議</h3>
        <div id="suggestionText"></div>  
    </div>
    
    <div class="button-group">
    <button onclick="history.back()" 
    style="padding: 10px 20px; font-size: 16px; border-radius: 8px; background-color:#2a5dba; color: white; border: none; cursor: pointer;">返回
    </button>

    <button id="finalButton" onclick="alert('輸出 語音情緒 pdf')">輸出</button>
    </div>

    <script>
        // --- 1. 全域變數定義 ---
        const chatMessages = document.getElementById("chatMessages");
        const chatInput = document.getElementById("chatInput");
        const chatHeader = document.getElementById("chatHeader");
        const dateList = document.getElementById("dateList");
        const records = {};
        let currentDate = null;

        // --- 2. 全域函式定義 ---
        function getTodayDate() {
            const today = new Date();
            return today.toISOString().split("T")[0];
        }

        function getCurrentTime() {
            const now = new Date();
            return now.toLocaleTimeString("zh-TW", { hour: "2-digit", minute: "2-digit" });
        }
        
        function switchChat(date) {
            currentDate = date;
            chatHeader.innerText = date;
            document.querySelectorAll(".chat-item").forEach(item => item.classList.remove("active"));
            const selected = document.querySelector(`.chat-item[data-date="${date}"]`);
            if (selected) selected.classList.add("active");

            // 向後端撈取該日期紀錄
            fetch(`/chat_history?date=${date}`)
                .then(res => res.json())
                .then(data => {
                    records[date] = data.history || [];
                    renderMessages();
                });
        }

        function sendMessage() {
            const text = chatInput.value.trim();
            if (text === "") return;

            let isNewChatSession = false;
            // 如果還沒選定任何聊天日期，這就是一個新的對話
            if (!currentDate) {
                currentDate = getTodayDate();
                isNewChatSession = true;

                // 如果今天日期還沒出現在左側列表上，就新增它
                if (!document.querySelector(`.chat-item[data-date="${currentDate}"]`)) {
                    addDateToList(currentDate);
                }
            }
            
            // 如果是全新的對話，我們手動設定UI，而不是呼叫會覆蓋資料的 switchChat
            if (isNewChatSession) {
                chatHeader.innerText = currentDate;
                document.querySelectorAll(".chat-item").forEach(item => item.classList.remove("active"));
                const selected = document.querySelector(`.chat-item[data-date="${currentDate}"]`);
                if (selected) selected.classList.add("active");

                // 確保本地端的 records 陣列已初始化
                if (!records[currentDate]) {
                    records[currentDate] = [];
                }
            }

            // 新增使用者訊息到本地端
            records[currentDate].push({ text, sender: "user", time: getCurrentTime() });

            chatInput.value = "";
            renderMessages(); // 立刻渲染，這時訊息還在

            // 呼叫後端 AI 回覆
            fetch("/chat_ai", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    message: text,
                    history: records[currentDate],
                    date: currentDate
                })
            })
            .then(res => res.json())
            .then(data => {
                if (data.reply) {
                    records[currentDate].push({ text: data.reply, sender: "ai", time: getCurrentTime() });
                    renderMessages();
                }
            });
        }

        function renderMessages() {
            chatMessages.innerHTML = "";
            if (records[currentDate] && records[currentDate].length > 0) {
                records[currentDate].forEach(msg => {
                    const msgDiv = document.createElement("div");
                    msgDiv.classList.add("message", msg.sender);
                    // 將換行符 \n 轉為 <br> 讓AI回覆的換行能正確顯示
                    const formattedText = msg.text.replace(/\n/g, '<br>');
                    msgDiv.innerHTML = `<div>${formattedText}</div><span class="timestamp">${msg.time}</span>`;
                    chatMessages.appendChild(msgDiv);
                });
            } else {
                // 提供更友善的初始提示
                chatMessages.innerHTML = "<p style='text-align:center; color:#888;'>尚無紀錄，開始聊天吧！</p>";
            }
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function addDateToList(date) {
            // ✨ 增加一道防線：如果日期已經存在於列表中，就直接返回，不要重複新增
            if (document.querySelector(`.chat-item[data-date="${date}"]`)) return;

            const item = document.createElement("div");
            item.classList.add("chat-item");
            item.setAttribute("data-date", date);

            const dateText = document.createElement("span");
            dateText.innerText = date;
            dateText.style.flex = "1";
            dateText.onclick = () => switchChat(date);

            const deleteBtn = document.createElement("span");
            deleteBtn.innerText = "✕";
            deleteBtn.classList.add("delete-date-btn");
            deleteBtn.onclick = (e) => {
                e.stopPropagation();
                if (confirm(`確定要刪除 ${date} 的聊天紀錄嗎？`)) {
                    fetch("/delete_chat_date", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ date })
                    })
                    .then(res => res.json())
                    .then(result => {
                        if (result.success) {
                            delete records[date];
                            item.remove();
                            if (currentDate === date) {
                                currentDate = null;
                                chatHeader.innerText = "尚未選擇日期";
                                renderMessages();
                            }
                        } else {
                            alert("刪除失敗：" + (result.error || ""));
                        }
                    });
                }
            };

            item.style.display = "flex";
            item.style.justifyContent = "space-between";
            item.style.alignItems = "center";
            item.appendChild(dateText);
            item.appendChild(deleteBtn);
            dateList.appendChild(item);
        }
        
        function createNewChat() {
            const today = getTodayDate();
            // 確保左側列表有今天的日期
            if (!document.querySelector(`.chat-item[data-date="${today}"]`)) {
                addDateToList(today);
                if (!records[today]) {
                    records[today] = [];
                }
            }
            // 切換到今天的聊天室
            switchChat(today);
        }
        
        // --- 3. 程式進入點 (所有啟動程式碼都在這裡) ---
        document.addEventListener('DOMContentLoaded', function() {
            // 綁定 Enter 鍵送出
            chatInput.addEventListener("keydown", e => {
                if (e.key === "Enter") {
                    sendMessage();
                }
            });

            // 綁定「+」按鈕的點擊事件
            document.getElementById('newChatBtn').addEventListener('click', createNewChat);
            
            // 頁面載入後，自動撈取所有歷史紀錄日期
            fetch("/chat_dates")
                .then(res => res.json())
                .then(data => {
                    // 從新到舊排序日期
                    data.dates.sort((a, b) => b.localeCompare(a));
                    data.dates.forEach(addDateToList);
                });
        });
    </script>
</body>
</html>
