<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>æƒ…æœ‰å¯åŸ</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            background-color: #e8f1fc;
            margin: 0;
            padding: 40px;
        }
        h2 {
            color: #2a5dba;
        }
        #result {
            margin-top: 20px;
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }
        #audioFile {
            margin-bottom: 10px;
        }
        canvas {
            max-width: 100%;
            height: auto;
        }
        .box-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
            flex-wrap: wrap;
        }
        .box {
            width: 400px;
            height: 400px;
            border: 2px solid #a3c0e9;
            border-radius: 15px;
            padding: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            text-align: center;     
            background-color: #ffffff;
            overflow-y: hidden;
        }
        .bottom-box {
            width: 640px;
            height: 300px;
            border: 2px solid #a3c0e9;
            border-radius: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            padding: 10px;
            background-color: #ffffff;
            margin: 30px auto;
            overflow-y: hidden;
        }
        #finalButton {
            padding: 10px 20px;
            font-size: 16px;
            border-radius: 8px;
            background-color: #2a5dba;
            color: white;
            border: none;
            cursor: pointer;
        }
        canvas {
            max-width: 100%;
            max-height: 300px;
            height: auto;
        }

        #finalButton:hover, button:hover {
            background-color: #1d4893;
        }
        #emotionLegend {
            margin-top: 20px;
            font-size: 15px;
            background-color: #ffffff;
            border: 2px solid #a3c0e9;
            border-radius: 10px;
            padding: 12px;
            line-height: 1.8;
            width: fit-content;
            margin-left: auto;
            margin-right: auto;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        }
        #suggestionText {
            font-size: 16px;
            line-height: 1.8;
            text-align: left;
            white-space: pre-wrap; /* é˜²æ­¢æ„å¤–ç©ºç™½æŠ˜è¡Œ */
            max-height: 220px;     /* å»ºè­°é«˜åº¦ï¼Œå¯ä¾éœ€æ±‚èª¿æ•´ */
            overflow-y: auto;      /* è¶…å‡ºæ™‚å¯æ»¾å‹• */
            padding-right: 8px;    /* é¿å…æ»¾å‹•æ¢å£“ä½æ–‡å­— */
        }

    </style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <h2>ä¸Šå‚³éŸ³è¨Šæª”æ¡ˆé€²è¡Œæƒ…ç·’è¾¨è­˜</h2>
    {% if session.role == "counselor" %}
        <label for="patientSelect">é¸æ“‡æ‚£è€…ï¼š</label>
        <select id="patientSelect">
            {% for patient in patients %}
                <option value="{{ patient.name }}">{{ patient.name }}</option>
            {% endfor %}
        </select><br/><br/>
    {% endif %}
    <input type="file" id="audioFile" accept=".wav" />
    <br/>
    <button onclick="uploadFile()">ä¸Šå‚³ä¸¦è¾¨è­˜</button>
    <p id="result">é æ¸¬çµæœå°‡é¡¯ç¤ºåœ¨é€™è£¡</p>
    <div id="emotionLegend" class="legend-box">
        <strong>æƒ…ç·’å°æ‡‰èªªæ˜ï¼š</strong><br/>
        ang: ç”Ÿæ°£ğŸ˜  ã€dis: å­æƒ¡ğŸ¤¢ ã€fear: å®³æ€•ğŸ˜¨ ã€
        happy: é–‹å¿ƒğŸ˜Š ã€neu: ä¸­æ€§ğŸ˜ ã€sad: å‚·å¿ƒğŸ˜¢ 
    </div>
    <!-- å…©å€‹å¯æ”¾æ±è¥¿çš„æ¡† -->
    <div class="box-container">
        <div class="box" id="box1">
            <h3>æ•´é«”æƒ…ç·’åœ“é¤…åœ–</h3>
            <canvas id="pieChart" width="280" height="180"></canvas>
        </div>
        <div class="box" id="box2">
            <h3>æ™‚é–“åºåˆ—æŠ˜ç·šåœ–</h3>
            <canvas id="lineChart" width="280" height="180"></canvas>
        </div>
    </div>

    <!-- ç¬¬ä¸‰å€‹æ¡†ï¼Œæ”¾åœ¨ä¸‹é¢ -->
    <div class="bottom-box" id="box3">
        <h3>æ–‡å­—å»ºè­°</h3>
        <div id="suggestionText"></div>  
    </div>
    
    <div class="button-group">
    <button onclick="history.back()" 
    style="padding: 10px 20px; font-size: 16px; border-radius: 8px; background-color:#2a5dba; color: white; border: none; cursor: pointer;">è¿”å›
    </button>

    <button id="finalButton" onclick="alert('è¼¸å‡º èªéŸ³æƒ…ç·’ pdf')">è¼¸å‡º</button>
    </div>

    <script>
        // --- 1. å…¨åŸŸè®Šæ•¸å®šç¾© ---
        const chatMessages = document.getElementById("chatMessages");
        const chatInput = document.getElementById("chatInput");
        const chatHeader = document.getElementById("chatHeader");
        const dateList = document.getElementById("dateList");
        const records = {};
        let currentDate = null;

        // --- 2. å…¨åŸŸå‡½å¼å®šç¾© ---
        function getTodayDate() {
            const today = new Date();
            return today.toISOString().split("T")[0];
        }

        function getCurrentTime() {
            const now = new Date();
            return now.toLocaleTimeString("zh-TW", { hour: "2-digit", minute: "2-digit" });
        }
        
        function switchChat(date) {
            currentDate = date;
            chatHeader.innerText = date;
            document.querySelectorAll(".chat-item").forEach(item => item.classList.remove("active"));
            const selected = document.querySelector(`.chat-item[data-date="${date}"]`);
            if (selected) selected.classList.add("active");

            // å‘å¾Œç«¯æ’ˆå–è©²æ—¥æœŸç´€éŒ„
            fetch(`/chat_history?date=${date}`)
                .then(res => res.json())
                .then(data => {
                    records[date] = data.history || [];
                    renderMessages();
                });
        }

        function sendMessage() {
            const text = chatInput.value.trim();
            if (text === "") return;

            let isNewChatSession = false;
            // å¦‚æœé‚„æ²’é¸å®šä»»ä½•èŠå¤©æ—¥æœŸï¼Œé€™å°±æ˜¯ä¸€å€‹æ–°çš„å°è©±
            if (!currentDate) {
                currentDate = getTodayDate();
                isNewChatSession = true;

                // å¦‚æœä»Šå¤©æ—¥æœŸé‚„æ²’å‡ºç¾åœ¨å·¦å´åˆ—è¡¨ä¸Šï¼Œå°±æ–°å¢å®ƒ
                if (!document.querySelector(`.chat-item[data-date="${currentDate}"]`)) {
                    addDateToList(currentDate);
                }
            }
            
            // å¦‚æœæ˜¯å…¨æ–°çš„å°è©±ï¼Œæˆ‘å€‘æ‰‹å‹•è¨­å®šUIï¼Œè€Œä¸æ˜¯å‘¼å«æœƒè¦†è“‹è³‡æ–™çš„ switchChat
            if (isNewChatSession) {
                chatHeader.innerText = currentDate;
                document.querySelectorAll(".chat-item").forEach(item => item.classList.remove("active"));
                const selected = document.querySelector(`.chat-item[data-date="${currentDate}"]`);
                if (selected) selected.classList.add("active");

                // ç¢ºä¿æœ¬åœ°ç«¯çš„ records é™£åˆ—å·²åˆå§‹åŒ–
                if (!records[currentDate]) {
                    records[currentDate] = [];
                }
            }

            // æ–°å¢ä½¿ç”¨è€…è¨Šæ¯åˆ°æœ¬åœ°ç«¯
            records[currentDate].push({ text, sender: "user", time: getCurrentTime() });

            chatInput.value = "";
            renderMessages(); // ç«‹åˆ»æ¸²æŸ“ï¼Œé€™æ™‚è¨Šæ¯é‚„åœ¨

            // å‘¼å«å¾Œç«¯ AI å›è¦†
            fetch("/chat_ai", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    message: text,
                    history: records[currentDate],
                    date: currentDate
                })
            })
            .then(res => res.json())
            .then(data => {
                if (data.reply) {
                    records[currentDate].push({ text: data.reply, sender: "ai", time: getCurrentTime() });
                    renderMessages();
                }
            });
        }

        function renderMessages() {
            chatMessages.innerHTML = "";
            if (records[currentDate] && records[currentDate].length > 0) {
                records[currentDate].forEach(msg => {
                    const msgDiv = document.createElement("div");
                    msgDiv.classList.add("message", msg.sender);
                    // å°‡æ›è¡Œç¬¦ \n è½‰ç‚º <br> è®“AIå›è¦†çš„æ›è¡Œèƒ½æ­£ç¢ºé¡¯ç¤º
                    const formattedText = msg.text.replace(/\n/g, '<br>');
                    msgDiv.innerHTML = `<div>${formattedText}</div><span class="timestamp">${msg.time}</span>`;
                    chatMessages.appendChild(msgDiv);
                });
            } else {
                // æä¾›æ›´å‹å–„çš„åˆå§‹æç¤º
                chatMessages.innerHTML = "<p style='text-align:center; color:#888;'>å°šç„¡ç´€éŒ„ï¼Œé–‹å§‹èŠå¤©å§ï¼</p>";
            }
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function addDateToList(date) {
            // âœ¨ å¢åŠ ä¸€é“é˜²ç·šï¼šå¦‚æœæ—¥æœŸå·²ç¶“å­˜åœ¨æ–¼åˆ—è¡¨ä¸­ï¼Œå°±ç›´æ¥è¿”å›ï¼Œä¸è¦é‡è¤‡æ–°å¢
            if (document.querySelector(`.chat-item[data-date="${date}"]`)) return;

            const item = document.createElement("div");
            item.classList.add("chat-item");
            item.setAttribute("data-date", date);

            const dateText = document.createElement("span");
            dateText.innerText = date;
            dateText.style.flex = "1";
            dateText.onclick = () => switchChat(date);

            const deleteBtn = document.createElement("span");
            deleteBtn.innerText = "âœ•";
            deleteBtn.classList.add("delete-date-btn");
            deleteBtn.onclick = (e) => {
                e.stopPropagation();
                if (confirm(`ç¢ºå®šè¦åˆªé™¤ ${date} çš„èŠå¤©ç´€éŒ„å—ï¼Ÿ`)) {
                    fetch("/delete_chat_date", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ date })
                    })
                    .then(res => res.json())
                    .then(result => {
                        if (result.success) {
                            delete records[date];
                            item.remove();
                            if (currentDate === date) {
                                currentDate = null;
                                chatHeader.innerText = "å°šæœªé¸æ“‡æ—¥æœŸ";
                                renderMessages();
                            }
                        } else {
                            alert("åˆªé™¤å¤±æ•—ï¼š" + (result.error || ""));
                        }
                    });
                }
            };

            item.style.display = "flex";
            item.style.justifyContent = "space-between";
            item.style.alignItems = "center";
            item.appendChild(dateText);
            item.appendChild(deleteBtn);
            dateList.appendChild(item);
        }
        
        function createNewChat() {
            const today = getTodayDate();
            // ç¢ºä¿å·¦å´åˆ—è¡¨æœ‰ä»Šå¤©çš„æ—¥æœŸ
            if (!document.querySelector(`.chat-item[data-date="${today}"]`)) {
                addDateToList(today);
                if (!records[today]) {
                    records[today] = [];
                }
            }
            // åˆ‡æ›åˆ°ä»Šå¤©çš„èŠå¤©å®¤
            switchChat(today);
        }
        
        // --- 3. ç¨‹å¼é€²å…¥é» (æ‰€æœ‰å•Ÿå‹•ç¨‹å¼ç¢¼éƒ½åœ¨é€™è£¡) ---
        document.addEventListener('DOMContentLoaded', function() {
            // ç¶å®š Enter éµé€å‡º
            chatInput.addEventListener("keydown", e => {
                if (e.key === "Enter") {
                    sendMessage();
                }
            });

            // ç¶å®šã€Œ+ã€æŒ‰éˆ•çš„é»æ“Šäº‹ä»¶
            document.getElementById('newChatBtn').addEventListener('click', createNewChat);
            
            // é é¢è¼‰å…¥å¾Œï¼Œè‡ªå‹•æ’ˆå–æ‰€æœ‰æ­·å²ç´€éŒ„æ—¥æœŸ
            fetch("/chat_dates")
                .then(res => res.json())
                .then(data => {
                    // å¾æ–°åˆ°èˆŠæ’åºæ—¥æœŸ
                    data.dates.sort((a, b) => b.localeCompare(a));
                    data.dates.forEach(addDateToList);
                });
        });
    </script>
</body>
</html>
